# DR_init과 ROS2 통신

import rclpy
from rclpy.node import Node
import DR_init
from std_msgs.msg import String
from robot_control.onrobot import RG

### robot_info
ROBOT_ID = "dsr01"
ROBOT_MODEL = "m0609"
VELOCITY, ACC = 60, 60

GRIPPER_NAME = "rg2"
TOOLCHARGER_IP = "192.168.1.1"
TOOLCHARGER_PORT = "502"

DEPTH_OFFSET = -5.0
MIN_DEPTH = 2.0

DR_init.__dsr__id = ROBOT_ID
DR_init.__dsr__model = ROBOT_MODEL

### context
rclpy.init()
dsr_node = rclpy.create_node("mini_control", namespace=ROBOT_ID)
DR_init.__dsr__node = dsr_node

try:
    from DSR_ROBOT2 import movej, movel, mwait, posx
except ImportError as e:
    print(f"Error importing DSR_ROBOT2: {e}")
    sys.exit()

### gripper
gripper = RG(GRIPPER_NAME, TOOLCHARGER_IP, TOOLCHARGER_PORT)

### robot_control_node
class Minipublisher(Node):
    def __init__(self):
        super().__init__("mini_publisher")

        self.init_robot()
        self.publisher = self.create_publisher(String, "test_topic", 10)
        self.timer = self.create_timer(1, self.timer_callback)
        self.control_test = self.create_client(String, "control_test")

    def timer_callback(self):
        msg = String()
        msg.data = "Hello Rokey"
        self.publisher.publish(msg)
        self.get_logger().info("Publishing: %s" % msg.data)

    def robot_control(self):
        print("Performing task...")

        # 초기 위치 및 목표 위치 설정
        JReady = [0, 0, 90, 0, 90, 0]
        pos1 = posx([500, 0, 200, 90, 180, 90])

        # 반복 동작 수행
        while True:       
            # 이동 명령 실행
            print("movej")
            movej(JReady, vel=VELOCITY, acc=ACC)
            print("movel")
            movel(pos1, vel=VELOCITY, acc=ACC)



'''
    def initialize_robot(self):
        from DSR_ROBOT2 import set_tool, set_tcp
        self.get_logger().info(f"ROBOT_ID: {ROBOT_ID}")
        self.get_logger().info(f"ROBOT_MODEL: {ROBOT_MODEL}")
        self.get_logger().info(f"VELOCITY: {VELOCITY}")
        self.get_logger().info(f"ACC: {ACC}")
        self.get_logger().info("#"*50)
        self.get_logger().info('initializing robot')

    def perform_task():
        from DSR_ROBOT2 import posx, movej, movel, mwait
        self.get_logger().info('publishing message')

        # 초기 위치 및 목표 위치 설정
        JReady = [0, 0, 90, 0, 90, 0]
        pos1 = posx([500, 0, 200, 90, 180, 90])

        while True:
            movej(JReady, vel=VELOCITY, acc=ACC)
            mwait()
            movel(pos1, vel=VELOCITY, acc=ACC)
            mwait()
'''

def main(args=None):
    rclpy.init(args=args)
'''
    dsr_node = rclpy.create_node("mini_control", namespace=ROBOT_ID)
    DR_init.__dsr__node = dsr_node
'''
    node = Minipublisher()
    while rclpy.ok():
        node.perform_task()
    rclpy.spin(node)
    node.destroy_node()
    rclpy.shutdown()

if __name__ == "__main__":
    main()
